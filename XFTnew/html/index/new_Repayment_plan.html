<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link href="../../css/public.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/mui.picker.min.css" />
		<link href="../../css/new_Repayment_plan.css" rel="stylesheet" />
	</head>
	<style>
		body,.mui-content{font-family: "微软雅黑";}
		/*.mui-bar-nav~.mui-content{padding-top: 0;}*/
		#promptBtn{
			width:92%;height:2.75rem;margin-left:4%;margin-top:1.53rem;font-size:18px;
			letter-spacing: 2px;background:#FF5A00;border:none;
		}
		.agreement{text-align: center;}
        .reg_agree{position: absolute;top: 10%;font-size: 13px;left: 40px;color: #FF5A00;}
        .mui-checkbox.mui-left input[type=checkbox]{left: 12px;}
        .mui-checkbox input[type=checkbox]{top: 2px;}
        .agreement .mui-checkbox input[type=checkbox]:before, .mui-radio input[type=radio]:before{
        	font-size: 24px;
        }
        #hank_img{
    		/*height:36px;*/
		    width: 4rem;z-index: 999;
		    position: absolute;top: 15px;left: 1rem;		    
		    /*background-position-y: center;background-repeat:no-repeat;*/
    	}
    	.mui-bar .mui-btn-link,.mui-checkbox input[type=checkbox]:checked:before, .mui-radio input[type=radio]:checked:before{color: #FF5A00;}
	</style>
	<body>
		<header id="header" class="mui-bar mui-bar-nav" style="box-shadow: none;background-color: #FFFFFF;">			
			<h1 id="title" class="mui-title">新增还款计划</h1>
			<button class="mui-action-back mui-btn mui-btn-blue mui-btn-link mui-btn-nav mui-pull-left">
				<span class="mui-icon mui-icon-left-nav"></span>返回
			</button>
		</header>
		<div class="mui-content">
			<div class="list-t-wrap">
			    <div id="pullrefresh" class="mui-scroll-wrapper">
			        <div class="mui-scroll">
			            <div class="list-wrapper">
			                <!--列表一定要放到容器内,因为会有一个div append到mui-scroll中,需要在底部才能起作用-->
			           		<div class="section_two">
								<ul class="mui-table-view" style="border-radius: 5px 5px 0 0;margin-top:0.65rem;padding-top:1rem;">
							    	<li class="mui-table-view-cell mui-media" style="height:1.75rem;position:relative;">
								        <a href="javascript:;" class="mui-navigate-right">
								        	
								            <!--<img id="hank_img" class="mui-media-object mui-pull-left" src="../../images/zgyh@3x.png" style="position:absolute;top:0.25rem;line-height:1.75rem;
				max-width: 1.25rem;height: 1.25rem;left:5.8%;">-->
								            <div class="mui-media-body" style="font-size:16px;color:#505050;">
								                <span style="position:absolute;top:0.13rem;left:6rem;" id="hank_name">
								                	中国银行<label id="card_number" style="margin-left: 10px;">尾号(8888)</label>
								                </span> 
								                <!--<span id="card_number" style="position:absolute;top:0.13rem;left:44%;">尾号(8888)</span>-->
								                <!--<p class='mui-ellipsis'>能和心爱的人一起睡觉，是件幸福的事情；可是，打呼噜怎么办？</p>-->
								            </div>
								        </a>
								    </li>
								</ul>
								<img id="hank_img" src="http://www.zhxft.com/static/yinhang/pingan.png"></img>
								<ul class="mui-table-view" style="border-radius: 0 0 5px 5px;margin-top:-4px;">
				<!--					<div style="width:4rem;height:4rem;position:absolute;right:7.2%;top:1.56rem;background:url(../../images/xzhk@3x.png) 0 0 no-repeat;background-size:100% 100%;"></div>-->
								    <li class="mui-table-view-cell mui-table-view-cell-p1" style="color:#505050;">
								    	<span style="margin-left:5.1rem;">持卡人:</span>
								    	<span id="card_name" style="margin-left:3%;">李**</span>
								    	<span id="repay_state" style="margin-left:9%;display: inline-block;width:18%;height:1.28rem;background:#DDDDDD;border-radius: 10px;font-size: 12px;text-align: center;color:#fff;display: none;">待还款</span></li>
								    <li class="mui-table-view-cell total_mony">
								    	<div>
								    		<p id="Quota" class="total_mony_p1">0.8%</p>
								    		<p class="total_mony_p2">费率</p>
								    	</div>
								    	<div>
								    		<p id="bill_day" class="total_mony_p1">10月</p>
								    		<p class="total_mony_p2">账单日</p>
								    	</div>
								    	<div>
								    		<p id="last_repay" class="total_mony_p1" style="text-align: center;">30日</p>
								    		<p class="total_mony_p2">最后还款日</p>
								    	</div>
								    </li>
								</ul>
							</div>
							<!--填写还款信息-->
							<div class="plan">
								<form class="mui-input-group" style="margin-bottom:0.9rem;">
									<div class="mui-input-row">
										<label>还款金额</label>
										<input id='repay_money' type="number" class="mui-input-clear mui-input" placeholder="请输入还款金额">
									</div>
									<div class="mui-input-row">
										<label>还款笔数</label>
										<input id='Bond' type="number" class="mui-input" placeholder="请输入还款计划笔数">
									</div>
									<div class="mui-input-row">
										<label>手续费</label>
										<input id='operation_fee' readonly="readonly" type="text" class="mui-input" placeholder="0.00">
									</div>
									<div class="mui-input-row">
										<label>开始时间</label>
										<input id="calendar" data-options='{"type":"date"}' type="text" readonly="readonly" class="mui-input" placeholder="选取还款开始时间">
									</div>
									<div class="mui-input-row">
										<label>结束时间</label>
										<input id='end_time' data-options='{"type":"date"}' type="text" readonly="readonly" class="mui-input" placeholder="选取还款结束时间">
									</div>
								</form>
							</div>
							<div class="agreement">
								<div class="mui-input-row mui-checkbox mui-left" style="display: inline-block;width: 100%;">
								  <label style="width: 5%;"></label>
								  <input name="checkbox1" value="1" type="checkbox" checked="checked">
								  <h4 id="reg_agree" class="reg_agree">我已经阅读信付通还款协议</h4>
								</div>
							</div>
							<button id="promptBtn" type="button" class="next mui-btn mui-btn-primary" style="margin-bottom: 50px;">预览还款计划</button>
			            </div>
			        </div>
			    </div>
			</div>
			
		</div>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/immersed.js" ></script>
		<script type="text/javascript" src="../../js/jquery-1.8.0.min.js" ></script>
		<script src="../../js/mui.picker.min.js"></script>
		<script type="text/javascript">
			mui.plusReady(function(){
				mui.init({  
					pullRefresh: 
				    {
				      container: '#pullrefresh',
				      down: {
				      	height: 50, //可选,默认50.触发下拉刷新拖动距离,
						auto: false, //可选,默认false.自动下拉刷新一次
						contentdown: "", //可选，在下拉可刷新状态时，下拉刷新控件上显示的标题内容
						contentover: "释放立即回弹", //可选，在释放可刷新状态时，下拉刷新控件上显示的标题内容
						contentrefresh: "", //可选，正在刷新状态时，下拉刷新控件上显示的标题内容
				        callback: pulldownRefresh
				      },//http://www.cnblogs.com/CyLee/p/5324224.html				      
				   	},
					hardwareAccelerated:true, //开启硬件加速	
					styles:{
						bounce: 'vertical',bounceBackground:'#fc1',
					}
				});
				function pulldownRefresh() {
					setTimeout(function() {
//					alert(&quot;shuaxin&quot;);
					mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
					})
				}
				// 创建加载内容窗口
				var topoffset='45px';
				if(plus.navigator.isImmersedStatusbar()){// 兼容immersed状态栏模式
					topoffset=(Math.round(plus.navigator.getStatusbarHeight())+45)+'px';
				} 
				document.getElementById('header').style.height=(immersed+44)+'px';
				if(mui.os.ios){
					document.querySelector('.mui-content').style.marginTop=(immersed+44)+'px';
					document.querySelector('.mui-scroll').style.marginTop=(immersed+44)+'px';
				}else if(mui.os.android){
					document.querySelector('#pullrefresh').style.marginTop=(immersed+44)+'px';
				}
//				document.querySelector('.mui-content').style.marginTop=(immersed)+'px';
				mui.alert('还款期间请保证信用卡状态正常，请勿调整临时额度，不动用每次还款的资金，否则可能导致还款失败哦！','温馨提示','','','div');
				
				var uid=plus.storage.getItem('uid');
				var token=plus.storage.getItem('token');
				var card_id=plus.webview.getWebviewById('new_Repayment_plan').card_id;
				card_id=parseInt(card_id);
				mui.ajax('http://www.zhxft.com/app/creditCard/cardDetail',{
					async:false,
					data:{
						uid:uid,
						token:token,
						cardId:card_id					
					},
					dataType:'JSON',//服务器返回json格式数据
					type:'post',//HTTP请求类型
					success:function(data){
						console.log(data);
						var arrParse = JSON.parse(data);
						if(arrParse.code=='0006'){
							plus.storage.clear();
							plus.storage.setItem("launchFlag", "林允");
							mui.confirm('你当前并未登录(或账号在其他手机登录以致此手机账号被退出)，是否前往登录！','提示',['是','否'],function(e){
								if(e.index==0){
									mui.openWindow({
										url: 'login.html',
										id: 'login',
										show: {
											autoShow:false,
											aniShow: 'pop-in',
											duration:'350',
										}//额外扩展参数
										,createNew:true,extras:{type:1},//是否重复创建同样id的webview，默认为false:不重复创建，直接显示
										styles:{softinputMode:'adjustResize'},
										waiting: {
											autoShow: true
										}
									});
								}
							},'div')
							return;
						}
//						document.getElementById('hank_img').style.backgroundImage="url("+arrParse.bankLogo+")";
						document.getElementById('hank_img').src=arrParse.bankLogo;
						document.getElementById('hank_name').innerHTML=''+arrParse.bankName+'<label id="card_number" style="margin-left: 10px;">尾号('+arrParse.endNum+')</label>';
//						document.getElementById('card_number').innerText='尾号('+arrParse.endNum+')';
						document.getElementById('card_name').innerText=arrParse.accountName;
						document.getElementById('Quota').innerText=arrParse.feeRate+'%';
						document.getElementById('bill_day').innerText=arrParse.accountDay;
						document.getElementById('last_repay').innerText=arrParse.repaymentDay;
					},
					error:function(xhr,error,errorThrown){
						console.log(error);
					}
				});
				
				window.addEventListener('kj_back',function(event){
					mui.back();
				});
				mui("body").on("tap", ".mui-icon-clear", function() {
//					document.getElementById('Bond').value='';
					document.getElementById('operation_fee').value='';
				})
				var Bond;//保证金
				document.getElementById('repay_money').addEventListener('input',function(){
					var repayAmount=document.getElementById('repay_money').value;
					if(repayAmount==''){
//						document.getElementById('Bond').value='';
						document.getElementById('operation_fee').value='';
						return;
					}
//					console.log(repayAmount)
					mui.ajax('http://www.zhxft.com/app/plan/deposit',{
						async:false,
						data:{
							uid:uid,
							token:token,
							repayAmount:repayAmount						
						},
						dataType:'JSON',//服务器返回json格式数据
						type:'post',//HTTP请求类型
						success:function(data){
							console.log(data);
							var arrParse = JSON.parse(data);
							Bond=arrParse.deposit;
							document.getElementById('operation_fee').value=arrParse.fee;
						},
						error:function(xhr,error,errorThrown){
							console.log(error);
						}
					});
				})
				
				document.getElementById('promptBtn').addEventListener('tap',function(){
					if($("input[type='checkbox']").is(':checked')){
						var repayAmount=document.getElementById('repay_money').value;
						var deposit=document.getElementById('Bond').value;
						var fee=document.getElementById('operation_fee').value;
						var day1=document.getElementById('calendar').value;
						var day2=document.getElementById('end_time').value;
//						var pay=parseFloat(parseFloat(deposit)+parseFloat(fee));
						if(repayAmount!='' && fee!='' && day1!='' && day2!='' && deposit!=''){													
							mui.ajax('http://www.zhxft.com/app/plan_news/makePlan',{
								async:false,
								data:{
									cardId:card_id,
									uid:uid,
									token:token,
									type:1,
									repayAmount:repayAmount,
									num:deposit,
									fee:fee,
									day1:day1,
									day2:day2
								},
								dataType:'JSON',//服务器返回json格式数据
								type:'post',//HTTP请求类型
								success:function(data){
									console.log(data);
									var arrParse = JSON.parse(data);
									if(arrParse.code=='0003'){
										mui.alert(arrParse.msg,'提示','','','div');
									}else if(arrParse.code=='0004'){
										mui.alert('提交计划失败','提示','','','div');
									}else if(arrParse.code=='0008'){
										mui.alert('开始日期不能小于账单日','提示','','','div');
									}else if(arrParse.code=='0009'){
										mui.alert('结束日期不能大于还款日','提示','','','div');
									}else if(arrParse.code=='0010'){
										mui.alert('还款中','提示','','','div');
									}else if(arrParse.code=='0011'){
										mui.alert('开始时间不能小于当天时间','提示','','','div');
									}else if(arrParse.code=='1000'){
										mui.alert('还款计划金额不能小于1000','提示','','','div');
									}else if(arrParse.code=='0013'){
										mui.alert('今日时间已超过18：00，请选择明日以后时间！','提示','','','div');
									}else if(arrParse.code=='0012'){
										mui.alert('还款结束日期不能小于开始日期(例如:开始日期与结束日期为同一天)','提示','','','div');
									}else{
//										mui.alert('还款期间请保证信用卡状态正常，并保持信用卡至少“'+(parseFloat(arrParse.deposit_xin)+parseFloat(fee))+'”余额，否则可能导致还款失败哦！','温馨提示','',function(e){
											mui.openWindow({
												url: 'preview.html',
												id: 'preview',
												show: {
													autoShow:false,
													aniShow: 'pop-in',
													duration:'350',
												},	
											    extras:{
											      	cardId:card_id,										
													repayAmount:repayAmount,
													deposit:deposit,
													fee:fee,
													day1:day1,
													day2:day2,
	//												pay:pay
											    },
											    createNew:true,
												waiting: {
													autoShow: true
												}
											});	
//										},'div');							
									}
								},
								error:function(xhr,error,errorThrown){
									console.log(error);
								}
							});
						}else{
							mui.alert('请完整的填写好计划信息','提示','','','div');
						}																	
					}else{
						mui.alert('请勾选用户协议','提示','','','div');
					}
				})
				document.getElementById('reg_agree').addEventListener('tap',function(){
			    	mui.openWindow({
						url: 'reg_agree.html',
						id: 'reg_agree',
						show: {
							autoShow:false,
							aniShow: 'pop-in',
							duration:'350',
						},styles:{
//							bounce: 'vertical',bounceBackground:'#fc1',
						},
						extras:{
							
						},//额外扩展参数
						waiting: {
							autoShow: true
						}
					});
			    })
				document.getElementById("calendar").addEventListener('tap', function() {
					var optionsJson = this.getAttribute('data-options') || '{}';
					var options = JSON.parse(optionsJson);
					var id = this.getAttribute('id');
					/*
					 * 首次显示时实例化组件
					 * 示例为了简洁，将 options 放在了按钮的 dom 上
					 * 也可以直接通过代码声明 optinos 用于实例化 DtPicker
					 */
					var picker = new mui.DtPicker(options);
					picker.show(function(rs) {
						/*
						 * rs.value 拼合后的 value
						 * rs.text 拼合后的 text
						 * rs.y 年，可以通过 rs.y.vaue 和 rs.y.text 获取值和文本
						 * rs.m 月，用法同年
						 * rs.d 日，用法同年
						 * rs.h 时，用法同年
						 * rs.i 分（minutes 的第二个字母），用法同年
						 */
						
						start_result=rs.text;						
						var stringTime =rs.text;
						var timestamp2 = Date.parse(new Date(stringTime));
						timestamp2 = timestamp2 / 1000;
						start_result=timestamp2;
						var day= Date.parse(new Date(getNowFormatDate()));
						day = day / 1000;
						var today=day;
//						if(start_result>today){
							document.getElementById("calendar").value = rs.text;
//						}else{
//							mui.alert('所选开始时间日期不能小于今日日期！','提示','','','div');
//						}
						/* 
						 * 返回 false 可以阻止选择框的关闭
						 * return false;
						 */
						/*
						 * 释放组件资源，释放后将将不能再操作组件
						 * 通常情况下，不需要示放组件，new DtPicker(options) 后，可以一直使用。
						 * 当前示例，因为内容较多，如不进行资原释放，在某些设备上会较慢。
						 * 所以每次用完便立即调用 dispose 进行释放，下次用时再创建新实例。
						 */
						picker.dispose();
					});
			    });
			    document.getElementById("end_time").addEventListener('tap', function() {
					var optionsJson = this.getAttribute('data-options') || '{}';
					var options = JSON.parse(optionsJson);
					var id = this.getAttribute('id');
					/*
					 * 首次显示时实例化组件
					 * 示例为了简洁，将 options 放在了按钮的 dom 上
					 * 也可以直接通过代码声明 optinos 用于实例化 DtPicker
					 */
					var picker = new mui.DtPicker(options);
					picker.show(function(rs) {						
						document.getElementById("end_time").value = rs.text;
						picker.dispose();
					});
			    });
			    function getNowFormatDate() {
				    var date = new Date();
				    var seperator1 = "-";
				    var seperator2 = ":";
				    var month = date.getMonth() + 1;
				    var strDate = date.getDate();
				    if (month >= 1 && month <= 9) {
				        month = "0" + month;
				    }
				    if (strDate >= 0 && strDate <= 9) {
				        strDate = "0" + strDate;
				    }
				    var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate;
//				            + " " + date.getHours() + seperator2 + date.getMinutes()
//				            + seperator2 + date.getSeconds();
				    return currentdate;
				}
				//关闭页面跳转动画
				plus.nativeUI.closeWaiting();
				//显示当前页面
				var self = plus.webview.currentWebview();
				self.show('pop-in',350);
			})
			
		</script>
	</body>

</html>